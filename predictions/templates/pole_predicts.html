{% extends 'main.html' %}

{% block content %}
{% load custom_filters %}
    <style>
        :root {
            --f1-red: #e10600;
            --f1-black: #15151e;
            --f1-dark-grey: #38383f;
            --f1-light-grey: #f1f2f3;
            --f1-white: #ffffff;
            --f1-accent: #0090d0;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Titillium Web', Arial, sans-serif;
        }

        body {
            background-color: var(--f1-light-grey);
            color: var(--f1-black);
            line-height: 1.6;
        }

        /* Header y Navegación */
        header {
            background-color: var(--f1-black);
            color: var(--f1-white);
            padding: 0;
            position: relative;
        }

        .logo-bar {
            background-color: var(--f1-red);
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            font-size: 24px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .nav-container {
            background-color: var(--f1-black);
            border-bottom: 3px solid var(--f1-red);
        }

        nav {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
        }

        nav ul {
            list-style: none;
            display: flex;
            justify-content: flex-start;
        }

        nav ul li {
            position: relative;
        }

        nav ul li a {
            display: block;
            color: var(--f1-white);
            text-decoration: none;
            padding: 15px 20px;
            font-weight: 600;
            transition: background-color 0.3s;
        }

        nav ul li a:hover {
            background-color: var(--f1-red);
        }

        nav ul li.active a {
            border-bottom: 3px solid var(--f1-red);
            margin-bottom: -3px;
        }

        main {
            padding: 30px 0;
        }

        .pole-prediction-container {
            max-width: 800px;
            margin: 0 auto;
            background-color: var(--f1-white);
            border-radius: 8px;
            padding: 30px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            border-top: 4px solid var(--f1-red);
        }

        .pole-title {
            color: var(--f1-red);
            font-size: 28px;
            margin-bottom: 20px;
            text-align: center;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .race-info {
            text-align: left;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid var(--f1-light-grey);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .race-info h3 {
            font-size: 24px;
            color: var(--f1-black);
            margin: 0;
        }

        .race-info p {
            font-size: 18px;
            color: var(--f1-dark-grey);
        }

        .countdown {
            font-size: 18px;
            font-weight: 600;
            color: var(--f1-dark-grey);
        }

        .countdown span {
            color: var(--f1-red);
        }

        .prediction-system {
            display: flex;
            flex-direction: column;
            gap: 30px;
        }

        .drivers-pool {
            background-color: var(--f1-light-grey);
            border-radius: 8px;
            padding: 20px;
            border: 2px dashed var(--f1-dark-grey);
        }

        .drivers-pool h3 {
            margin-bottom: 15px;
            color: var(--f1-dark-grey);
            text-align: center;
            font-size: 20px;
        }

        .drivers-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 15px;
        }

        .driver-card {
            background-color: var(--f1-white);
            border-radius: 10px;
            padding: 15px;
            cursor: pointer;
            transition: all 0.3s;
            border-left: 6px solid #ccc;
            display: flex;
            flex-direction: column;
            align-items: center;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            height: 140px;
        }

        .driver-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.15);
        }

        .driver-card img {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            object-fit: cover;
            margin-bottom: 12px;
            border: 3px solid #f0f0f0;
        }

        .driver-info {
            width: 100%;
            text-align: center;
        }

        .driver-info .name {
            font-weight: 700;
            font-size: 14px;
            margin-bottom: 5px;
        }

        .driver-info .team {
            font-size: 12px;
            color: var(--f1-dark-grey);
            font-weight: 600;
            padding: 4px 8px;
            border-radius: 4px;
            background-color: var(--f1-light-grey);
            display: inline-block;
            margin-top: 5px;
        }

        .pole-prediction {
            margin-top: 30px;
            text-align: center;
        }

        .pole-prediction h3 {
            margin-bottom: 15px;
            color: var(--f1-red);
            font-size: 22px;
            text-transform: uppercase;
        }

        .pole-slot {
            display: flex;
            align-items: center;
            background: linear-gradient(to right, #FFD700, #E0E0E0);
            border-radius: 8px;
            padding: 20px;
            transition: all 0.2s;
            min-height: 120px;
            cursor: pointer;
            margin: 0 auto;
            max-width: 500px;
            border: 3px dashed #FFD700;
        }

        .pole-slot:hover {
            box-shadow: 0 0 15px rgba(255, 215, 0, 0.5);
        }

        .pole-slot.filled {
            border-style: solid;
        }

        .position-number {
            display: flex;
            justify-content: center;
            align-items: center;
            width: 50px;
            height: 50px;
            background-color: gold;
            color: var(--f1-black);
            border-radius: 50%;
            font-weight: 700;
            margin-right: 20px;
            font-size: 24px;
        }

        .pole-slot-content {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 80px;
        }

        .empty-slot-msg {
            color: #777;
            font-style: italic;
            font-size: 16px;
            text-align: center;
        }

        .selected-driver {
            display: flex;
            align-items: center;
            width: 100%;
        }

        .selected-driver img {
            width: 80px;
            height: 80px;
            margin-right: 20px;
            border-radius: 50%;
            border: 3px solid gold;
            box-shadow: 0 0 15px rgba(255, 215, 0, 0.5);
        }

        .driver-details {
            text-align: left;
        }

        .driver-details .name {
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 5px;
        }

        .driver-details .team {
            font-size: 18px;
            color: var(--f1-dark-grey);
            font-weight: 600;
        }

        .remove-driver {
            color: var(--f1-red);
            background: none;
            border: none;
            cursor: pointer;
            font-size: 24px;
            margin-left: auto;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            transition: background-color 0.3s;
        }

        .remove-driver:hover {
            background-color: rgba(225, 6, 0, 0.1);
        }

        .points-info {
            margin-top: 15px;
            background-color: var(--f1-light-grey);
            padding: 15px;
            border-radius: 8px;
            text-align: center;
        }

        .points-info p {
            margin: 0;
            font-size: 18px;
        }

        .points-value {
            font-weight: 700;
            color: var(--f1-red);
            font-size: 22px;
        }

        .actions {
            margin-top: 30px;
            text-align: center;
        }

        .action-btn {
            display: inline-block;
            background-color: var(--f1-red);
            color: var(--f1-white);
            text-decoration: none;
            padding: 15px 30px;
            border-radius: 4px;
            font-size: 18px;
            font-weight: 600;
            transition: background-color 0.3s, transform 0.2s;
            border: none;
            cursor: pointer;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin: 0 10px;
        }

        .action-btn:hover {
            background-color: #c10500;
            transform: translateY(-3px);
        }

        .action-btn:active {
            transform: translateY(0);
        }

        .action-btn.secondary {
            background-color: var(--f1-dark-grey);
        }

        .action-btn.secondary:hover {
            background-color: #2a2a30;
        }

        /* Estilos para los equipos */
        .mercedes { border-left-color: #00D2BE; }
        .red-bull { border-left-color: #0600EF; }
        .ferrari { border-left-color: #DC0000; }
        .mclaren { border-left-color: #FF8700; }
        .aston-martin { border-left-color: #006F62; }
        .alpine { border-left-color: #0090FF; }
        .williams { border-left-color: #005AFF; }
        .haas { border-left-color: #232323; }
        .alpha-tauri { border-left-color: #2B4562; }
        .racing-bulls { border-left-color: #6692ff; }
        .sauber { border-left-color: #52E252; }

        .highlight-placement {
            animation: highlight 0.8s ease-in-out;
        }

        @keyframes highlight {
            0%, 100% { 
                background-color: transparent; 
            }
            50% { 
                background-color: rgba(255, 215, 0, 0.3); 
                box-shadow: 0 0 20px rgba(255, 215, 0, 0.8);
            }
        }

        /* Estilos responsive */
        @media (max-width: 768px) {
            .pole-prediction-container {
                padding: 20px;
                margin: 0 15px;
            }
            
            .drivers-grid {
                grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            }
            
            .pole-slot {
                flex-direction: column;
                text-align: center;
                padding: 15px;
            }
            
            .position-number {
                margin-right: 0;
                margin-bottom: 15px;
            }
            
            .selected-driver {
                flex-direction: column;
            }
            
            .selected-driver img {
                margin-right: 0;
                margin-bottom: 15px;
            }
            
            .driver-details {
                text-align: center;
                margin-bottom: 15px;
            }
            
            .remove-driver {
                margin-left: 0;
            }
        }
    </style>
</head>
<body>
    <main>
        <div class="pole-prediction-container">
            <h2 class="pole-title">Predicción de Pole Position</h2>
            
            <div class="race-info">
                <div>
                    <h3>{{ gp.name }}</h3>
                    <p> {{ gp.location}} </p>
                </div>
                <div class="countdown">Tiempo restante: <span id="countdown-timer">{{ remaining_time }}</span></div>
            </div>
            
            <div class="prediction-system">
                <div class="pole-prediction">
                    <h3>¿Quién conseguirá la pole?</h3>
                    <div class="pole-slot" id="pole-position">
                        <div class="position-number">P1</div>
                        <div class="pole-slot-content">
                            <div class="empty-slot-msg">Haz clic en un piloto abajo para seleccionarlo como pole position</div>
                        </div>
                    </div>
                    
                    <div class="points-info">
                        <p>Si aciertas, ganas <span class="points-value">4 puntos</span></p>
                    </div>
                </div>
                
                <div class="drivers-pool">
                    <h3>Pilotos</h3>
                    
                    <div class="drivers-grid">
                        {% for driver in drivers %}
                        <div class="driver-card {{ ABB|get:driver.team_name }}" data-team="{{driver.team_name}}" onclick="selectDriver('{{ driver.first_name}} {{ driver.last_name}}', '{{ driver.team_name }}', '{{ driver.headshot }}', '{{ ABB|get:driver.team_name }}', '{{ driver.id }}')">
                            <img src="{{ driver.headshot }}" alt="{{ driver.first_name}} {{driver.last_name}}" data-driver-id="{{ driver.id }}">
                            <div class="driver-info">
                                <div class="name">{{ driver.first_name}} {{driver.last_name}}</div>
                                <div class="team">{{ driver.team_name}}</div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
            
            <form id="prediction-form" data-save-url="{% url 'save_pred' %}">
                <input type="hidden" name="csrfmiddlewaretoken" value="{{ csrf_token }}">
                <div id="race-data" data-race-id="{{ session.id }}"></div>
                <div class="actions">
                    <button class="action-btn" id="submit-prediction">Enviar Predicción</button>
                </div>
            </form> 
        </div>
    </main>

    <script>
        // Simular una cuenta regresiva
        function updateCountdown() {
            const countdownElement = document.getElementById('countdown-timer');
            const parts = countdownElement.innerText.split(':');
            let hours = parseInt(parts[0]);
            let minutes = parseInt(parts[1]);
            let seconds = parseInt(parts[2]);
            
            seconds--;

            if (countdownElement.textContent == "¡Tiempo finalizado!") {
                countdownElement.textContent = "¡Tiempo finalizado!";
                countdownElement.style.color = "var(--f1-red)";
                const actionsDiv = document.querySelector(`.actions`);
                // Limpiar el contenido actual
                actionsDiv.innerHTML = '';
                return;
            }
            
            if (seconds < 0) {
                seconds = 59;
                minutes--;
                
                if (minutes < 0) {
                    minutes = 59;
                    hours--;
                    
                    if (hours < 0) {
                        countdownElement.innerText = "¡Clasificación iniciada!";
                        clearInterval(countdownInterval);
                        return;
                    }
                }
            }
            
            const formattedHours = hours.toString().padStart(2, '0');
            const formattedMinutes = minutes.toString().padStart(2, '0');
            const formattedSeconds = seconds.toString().padStart(2, '0');
            
            countdownElement.innerText = `${formattedHours}:${formattedMinutes}:${formattedSeconds}`;
        }
        
        const countdownInterval = setInterval(updateCountdown, 1000);
        
        // Función para seleccionar un piloto para la pole
        function selectDriver(name, team, imgSrc, teamClass, driverId) {
            const poleSlot = document.getElementById('pole-position');
            const poleSlotContent = poleSlot.querySelector('.pole-slot-content');
            
            // Crear el HTML para el piloto seleccionado
            const driverHTML = `
                <div class="selected-driver">
                    <img src="${imgSrc}" alt="${name}" data-driver-id="${driverId}">
                    <div class="driver-details">
                        <div class="name">${name}</div>
                        <div class="team">${team}</div>
                    </div>
                    <button class="remove-driver" onclick="removeDriver(event)">×</button>
                </div>
            `;
            
            // Actualizar el contenido del slot
            poleSlotContent.innerHTML = driverHTML;
            
            // Agregar la clase del equipo y de filled al slot
            poleSlot.className = `pole-slot filled ${teamClass}`;
            
            // Añadir una animación de destaque
            poleSlot.classList.add('highlight-placement');
            setTimeout(() => {
                poleSlot.classList.remove('highlight-placement');
            }, 800);
        }
        
        // Función para quitar un piloto de la pole
        function removeDriver(event) {
            event.stopPropagation();
            
            const poleSlot = document.getElementById('pole-position');
            const poleSlotContent = poleSlot.querySelector('.pole-slot-content');
            
            // Restaurar el mensaje de slot vacío
            poleSlotContent.innerHTML = '<div class="empty-slot-msg">Haz clic en un piloto abajo para seleccionarlo como pole position</div>';
            
            // Quitar clases adicionales del slot
            poleSlot.className = 'pole-slot';
        }
        
        // Event listeners para los botones
        document.getElementById('submit-prediction').addEventListener('click', function(event) {
            event.preventDefault(); // Evitar el comportamiento por defecto del botón

            const poleSlot = document.getElementById('pole-position');
            
            if (poleSlot.classList.contains('filled')) {
                const driverName = poleSlot.querySelector('.name').innerText;
                const driverId = poleSlot.querySelector('img').dataset.driverId; // Asegúrate de que el ID del piloto esté disponible

                // Preparar los datos para enviar al servidor
                const predictionData = {
                    race_id: document.getElementById('race-data').dataset.raceId,
                    positions: {
                        '1': driverId
                    }
                };

                // Obtener el token CSRF de forma adecuada
                const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;

                // Enviar datos al servidor mediante fetch
                fetch(document.getElementById('prediction-form').dataset.saveUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrfToken
                    },
                    body: JSON.stringify(predictionData)
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert('¡Predicción guardada con éxito!');
                    } else {
                        alert('Error al guardar la predicción: ' + data.error);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Error al guardar la predicción. Por favor, intenta nuevamente.');
                });
            } else {
                alert('Por favor, selecciona un piloto para la pole position antes de enviar tu predicción.');
            }
        });
    </script>
</body>

{% endblock content %}